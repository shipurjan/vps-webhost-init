name: Deploy to VPS

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: deploy
    if: ${{ github.actor != 'dependabot[bot]' && (github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success') }}
    steps:
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: '${{ secrets.VPS_HOST }}'
          username: root
          key: '${{ secrets.VPS_SSH_KEY }}'
          port: '${{ secrets.SSH_PORT }}'
          script: |
            # Navigate to project directory
            cd /root/${{ secrets.VPS_HOST }} || exit 1

            # Fetch and reset to master branch
            echo "Fetching latest changes from master..."
            git fetch origin master
            git checkout master
            git reset --hard origin/master

            # Navigate to docker directory
            cd docker

            # Rebuild and restart services (zero downtime, wait for health)
            echo "Rebuilding and restarting containers..."
            docker compose up -d --build --wait

            # Show container status
            docker compose ps
